<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard ‚Äì Get More Diners</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* Palette */
  :root {
    --primary: #D9A066;
    --secondary: #F1D9C9;
    --accent: #B17B45;
    --bg: #E1DBD8;
    --text: #3E3E3E;
  }

  body { background-color: var(--bg); color: var(--text); }

  /* Card Styles */
  .card {
    background: #fff;
    border-radius: 1rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    padding: 1.5rem;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .card:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }

  /* Buttons */
  .btn-primary {
    background: linear-gradient(90deg, var(--accent), var(--primary));
    color: white;
    font-weight: 600;
    border-radius: 0.5rem;
    padding: 0.6rem 1rem;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .btn-primary:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
  .btn-secondary {
    background: var(--secondary);
    color: var(--text);
    font-weight: 500;
    border-radius: 0.5rem;
    padding: 0.6rem 1rem;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .btn-secondary:hover { transform: scale(1.03); box-shadow: 0 3px 8px rgba(0,0,0,0.1); }

  /* Table Styling */
  table { width: 100%; border-collapse: separate; border-spacing: 0; border-radius: 0.5rem; overflow: hidden; }
  th, td { padding: 0.75rem; text-align: left; }
  th { background: var(--secondary); color: var(--text); font-weight: 600; }
  tbody tr:nth-child(even) { background: #FDF7F2; }
  tbody tr:hover { background: #F1E5D1; }

  /* AI Offer Preview */
  .fade-in { animation: fadeIn 0.3s ease-in-out forwards; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px);} to { opacity: 1; transform: translateY(0);} }
</style>
</head>
<body class="font-sans min-h-screen flex flex-col">

  <!-- Navbar -->
<nav class="bg-white shadow-md py-4 mb-6">
  <div class="container mx-auto flex justify-between items-center px-6">
    <h1 class="text-2xl font-bold" style="color: var(--primary)">üçΩ Get More Diners</h1>
    <div class="flex space-x-4">
      <a href="/dashboard" class="font-medium hover:text-green-600 transition-colors">Dashboard</a>
      <a href="/logout" class="font-medium hover:text-red-600 transition-colors">Logout</a>
    </div>
  </div>
</nav>

  <!-- Main Dashboard -->
<main class="container mx-auto px-6 space-y-8 flex-grow">

  <!-- Greeting -->
  <h2 class="text-3xl font-bold" style="color: var(--primary)">Welcome to Your Dashboard</h2>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

    <!-- Restaurant Profile -->
    <div class="card border-l-4 border-[#D9A066]">
      <h3 class="text-2xl font-semibold mb-3" style="color: var(--primary)">Your Restaurant</h3>
      <p>Here‚Äôs your current profile:</p>
      <ul class="mt-4 space-y-2 text-gray-700">
        <li><strong>Name:</strong> {{ restaurant.name if restaurant else "N/A" }}</li>
        <li><strong>Cuisine:</strong> {{ restaurant.cuisine if restaurant else "N/A" }}</li>
        <li><strong>Location:</strong> {{ restaurant.location if restaurant else "N/A" }}</li>
      </ul>
    </div>

    <!-- Search Diners -->
    <div class="card border-l-4 border-[#D9A066]">
      <h3 class="text-2xl font-semibold mb-3" style="color: var(--primary)">üîç Search Diners</h3>
      <form id="searchForm" class="space-y-3">
          <select id="stateSelect" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-400">
            <option value="">-- Select State --</option>
            <option value="Alabama">Alabama</option>
            <option value="Arizona">Arizona</option>
            <option value="California">California</option>
            <option value="Colorado">Colorado</option>
            <option value="Connecticut">Connecticut</option>
            <option value="Delaware">Delaware</option>
            <option value="District of Columbia">District of Columbia</option>
            <option value="ENG">ENG</option>
            <option value="Florida">Florida</option>
            <option value="Georgia">Georgia</option>
            <option value="Hawaii">Hawaii</option>
            <option value="Illinois">Illinois</option>
            <option value="Kansas">Kansas</option>
            <option value="Kentucky">Kentucky</option>
            <option value="Louisiana">Louisiana</option>
            <option value="Maine">Maine</option>
            <option value="Maryland">Maryland</option>
            <option value="Massachusetts">Massachusetts</option>
            <option value="Michigan">Michigan</option>
            <option value="Minnesota">Minnesota</option>
            <option value="Nevada">Nevada</option>
            <option value="New Hampshire">New Hampshire</option>
            <option value="New Jersey">New Jersey</option>
            <option value="New York">New York</option>
            <option value="North Carolina">North Carolina</option>
            <option value="Ohio">Ohio</option>
            <option value="Oregon">Oregon</option>
            <option value="Pennsylvania">Pennsylvania</option>
            <option value="South Carolina">South Carolina</option>
            <option value="Tennessee">Tennessee</option>
            <option value="Texas">Texas</option>
            <option value="Utah">Utah</option>
            <option value="Virginia">Valencian Community</option>
            <option value="Vermont">Vermont</option>
            <option value="Virginia">Virginia</option>
            <option value="Washington">Washington</option>
          </select>

          <select id="citySelect" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-400">
            <option value="">-- Select City --</option>
          </select>

          <select id="dinerType" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-400">
            <option value="">-- Select Diner Type --</option>
            <option value="Pubs">Pubs</option>
            <option value="Fine Dining">Fine Dining</option>
            <option value="Coffee Shops">Coffee Shops</option>
            <option value="Take Out">Take Out</option>
          </select>

          <button type="submit" class="w-full rounded-lg btn-primary">Search</button>
          <button id="selectAllDiners" type="button" class="w-full btn-secondary">
            Select All
          </button>
        </form>
        <div id="searchResults" class="mt-4 text-sm text-gray-700"></div>
      </div>
    </div>

    <!-- AI Offer -->
    <div class=" ">
      <h3 class="text-2xl font-semibold mb-3" style="color: var(--primary)">ü§ñ Create AI Offer</h3>

      <input type="text" id="offerTitle" placeholder="Offer Title"
            class="w-full px-3 py-2 border rounded-lg mb-3">

      <input type="date" id="offerEndDate" 
      class="w-full px-3 py-2 border rounded-lg mb-3">

      <textarea id="aiOfferMessage" placeholder="AI will generate message here..." required
      class="w-full px-3 py-2 border rounded-lg mb-3"></textarea>

      <button type="button" id="generateOffer" class="w-full btn-primary mb-3">
        Generate AI Message
      </button>

      <button id="sendOffer" class="w-full btn-primary mb-3">
        Send Offer
      </button>

      <p id="offerStatus" class="mt-2 text-sm text-gray-600"></p>
    </div>

    <!-- Offer Preview Card -->
    <div id="previewCard" class="card border-l-4 border-[#D9A066] fade-in hidden">
      <h3 class="text-xl font-semibold text-accent mb-2">Offer Preview</h3>
      <p id="offerPreviewText" class="mb-2 text-gray-700"></p>
      <p><strong>Recipients:</strong> <span id="previewRecipients" class="text-gray-700"></span></p>
      <div class="flex space-x-2 mt-3">
        <button id="confirmSendBtn" class="btn-primary mt-2">Send Offer</button>
      </div>
    </div>

    <!-- Past Campaigns -->
    <div class="card border-l-4 border-[#D9A066]">
      <h3 class="text-2xl font-semibold mb-4" style="color: var(--primary)">üìä Past Campaigns</h3>
      <table class="w-full text-left border-collapse rounded-lg overflow-hidden">
        <thead>
          <tr class="bg-[#F5F3EF] text-gray-800">
            <th class="p-3 border">Title</th>
            <th class="p-3 border">Date</th>
            <th class="p-3 border">Recipients</th>
          </tr>
        </thead>
        <tbody id="campaignTable" class="text-gray-700"></tbody>
      </table>
    </div>

  </main>

  <footer class="bg-card py-6 text-center text-accent font-medium">
    ¬© 2025 Get More Diners. All rights reserved.
  </footer>


  <script>
    const restaurantId = "{{ restaurant.id if restaurant else '' }}";

    document.getElementById("stateSelect").addEventListener("change", async function() {
      const state = this.value;
      const citySelect = document.getElementById("citySelect");
      citySelect.innerHTML = "<option value=''>Loading...</option>";
    
      if (state) {
        const res = await fetch(`/cities-by-state?state=${encodeURIComponent(state)}`);
        const cities = await res.json();
    
        let options = "<option value=''>Select City</option>";
        cities.forEach(city => {
          options += `<option value="${city}">${city}</option>`;
        });
        citySelect.innerHTML = options;
      } else {
        citySelect.innerHTML = "<option value=''>Select City</option>";
      }
    });

    // ------------------ Diner Search ------------------
  document.getElementById("searchForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const state = document.getElementById("stateSelect").value;
    const city = document.getElementById("citySelect").value;
    const type = document.getElementById("dinerType").value;

    let url = `/search-diners-json?state=${encodeURIComponent(state)}&city=${encodeURIComponent(city)}`;
    if (type) url += `&type=${encodeURIComponent(type)}`;

    const res = await fetch(url);
    const data = await res.json();

    let output = "";
    if (data.length > 0) {
      output = "<ul class='list-disc ml-4'>";
      data.forEach(d => {
        output += `<li>
                     <input type="checkbox" name="diner_ids" data-email="${d.email}" class="mr-2">
                     ${d.name} (${d.city}, ${d.state})
                   </li>`;
      });
      output += "</ul>";
    } else {
      output = "No diners found.";
    }
    document.getElementById("searchResults").innerHTML = output;
  });


      // ------------------ Select All Diners ------------------
      document.getElementById("selectAllDiners").addEventListener("click", () => {
      const checkboxes = document.querySelectorAll("input[name='diner_ids']");
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      checkboxes.forEach(cb => cb.checked = !allChecked); // toggle
    });

    // AI Offer
    document.getElementById("generateOffer").addEventListener("click", async () => {
      const title = document.getElementById("offerTitle").value;
      const endDate = document.getElementById("offerEndDate").value;
      if (!title || !endDate) return alert("Please fill title and end date.");

      try {
        const res = await fetch("/generate-ai-offer", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({title, end_date: endDate, restaurant_id: restaurantId})
        });
        const data = await res.json();
        document.getElementById("aiOfferMessage").value = data.message || "";
      } catch (err) {
        console.error(err);
        alert("Failed to generate AI message.");
      }
    });

    // ------------------ Send Offer directly ------------------
  document.getElementById("sendOffer").addEventListener("click", async () => {
    const title = document.getElementById("offerTitle").value;
    const message = document.getElementById("aiOfferMessage").value;
    const selectedDiners = [...document.querySelectorAll("input[name='diner_ids']:checked")]
                           .map(cb => cb.dataset.email);

    if (!title || !message || selectedDiners.length === 0) {
      return alert("Fill all fields and select diners.");
    }

    try {
      const res = await fetch("/send-offer", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          restaurant_id: restaurantId,
          restaurant_name: "{{ restaurant.name if restaurant else 'Your Restaurant' }}",
          title: title,
          message: message,
          recipients: selectedDiners
        })
      });

      const data = await res.json();
      document.getElementById("offerStatus").innerText = data.message || data.error;
      loadPastCampaigns();
    } catch (err) {
      console.error(err);
      alert("Failed to save offer.");
    }
  });
    
   // --- Preview Card Functionality ---
document.getElementById("generateOffer").addEventListener("click", async () => {
  const title = document.getElementById("offerTitle").value;
  const endDate = document.getElementById("offerEndDate").value;
  if (!title || !endDate) return alert("Please fill title and end date.");

  try {
    const res = await fetch("/generate-ai-offer", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({title, end_date: endDate, restaurant_id: restaurantId})
    });
    const data = await res.json();
    document.getElementById("aiOfferMessage").value = data.message || "";

    // Show preview card
    const selectedDiners = [...document.querySelectorAll("input[name='diner_ids']:checked")].map(cb => cb.dataset.email);
    if (selectedDiners.length === 0) return alert("Please select diners to preview the offer.");

    document.getElementById("offerPreviewText").innerText = `${title}\n\n${data.message}`;
    document.getElementById("previewRecipients").innerText = selectedDiners.join(", ");
    document.getElementById("previewCard").style.display = "block";

  } catch (err) {
    console.error(err);
    alert("Failed to generate AI message.");
  }
});

/// ------------------ Confirm Send from Preview ------------------
document.getElementById("confirmSendBtn").addEventListener("click", async () => {
  const selectedDiners = document.getElementById("previewRecipients").innerText.split(", ").map(e => e.trim());
  const title = document.getElementById("offerTitle").value;

  try {
    const res = await fetch("/send-offer", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        restaurant_id: restaurantId,
        restaurant_name: "{{ restaurant.name if restaurant else 'Your Restaurant' }}",
        title: title,
        message: document.getElementById("aiOfferMessage").value,
        recipients: selectedDiners
      })
    });
    const data = await res.json();
    alert(`Offer sent successfully to ${selectedDiners.length} diners!`);
    document.getElementById("previewCard").style.display = "none";
    loadPastCampaigns();
  } catch (err) {
    console.error(err);
    alert("Failed to send offer.");
  }
});

async function loadPastCampaigns() {
  if (!restaurantId) return;
  try {
    const res = await fetch(`/offers/${restaurantId}`);
    const offers = await res.json();
    let tableRows = "";
    offers.forEach(o => {
      const date = o.created_at ? new Date(o.created_at).toLocaleDateString() : "-";
      tableRows += `
        <tr>
          <td class="p-3 border">${o.title}</td>
          <td class="p-3 border">${date}</td>
          <td class="p-3 border">${o.recipient_count}</td>
        </tr>`;
    });
    document.getElementById("campaignTable").innerHTML = tableRows;
  } catch (err) {
    console.error(err);
    document.getElementById("campaignTable").innerHTML = "<tr><td colspan='3'>Failed to load campaigns</td></tr>";
  }
}

// Load campaigns on page load
window.addEventListener("DOMContentLoaded", loadPastCampaigns);
  </script>
</body>
</html>
